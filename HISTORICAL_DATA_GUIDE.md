# 历史数据处理指南

## 概述

积分管理系统现在支持导入和处理历史数据，能够正确处理不同时期的直播观看记录，并自动应用90天有效期规则。

## 主要改进

### 1. 智能日期提取

系统现在能够从多种列中提取日期信息：

- **优先级1**: `首次观看直播时间` (StartTime)
- **优先级2**: `最近观看直播时间` (EndTime) 
- **优先级3**: 任何包含"时间"、"日期"、"date"、"time"的列
- **备选方案**: 当前日期（会显示警告）

### 2. 历史数据过滤

- **90天规则**: 自动过滤超过90天的历史数据
- **重复检查**: 防止同一用户同一天的重复积分
- **数据保护**: 保留有效期内的所有历史记录

### 3. 改进的积分累计

- **防重复**: 每个用户每天最多只能获得1分
- **历史兼容**: 正确处理历史数据的积分累计
- **数据完整性**: 确保积分记录的准确性

## 支持的数据格式

### 时间格式

系统支持多种时间格式：

```
标准格式:
- 2023-03-10 17:05:35
- 2023/03/10 17:05:35
- 2023-03-10

时间戳格式:
- 1678435535 (Unix时间戳)
- 2023-03-10T17:05:35Z (ISO格式)
```

### 时长格式

```
中文格式:
- 1小时15分30秒
- 45分20秒
- 2小时30分

英文格式:
- 1:15:30
- 45:20
- 2:30:00

数字格式:
- 75 (分钟)
- 4530 (秒)
```

## 使用示例

### 1. 当前数据导入

```csv
用户id,用户名称,直播观看时长,首次观看直播时间
100001,小明,1小时15分30秒,2024-01-15 20:30:00
100002,小红,45分20秒,2024-01-15 21:00:00
```

**处理结果**: 
- 使用当前日期作为积分日期
- 符合条件的用户获得积分

### 2. 历史数据导入

```csv
用户id,用户名称,直播观看时长,首次观看直播时间
100001,小明,1小时15分30秒,2023-12-01 20:30:00
100002,小红,45分20秒,2023-11-15 21:00:00
100003,小李,50分10秒,2023-10-01 19:00:00
```

**处理结果**:
- 2023-12-01的数据: ✅ 保留（在90天内）
- 2023-11-15的数据: ✅ 保留（在90天内）
- 2023-10-01的数据: ❌ 过滤（超过90天）

### 3. 混合数据导入

```csv
用户id,用户名称,直播观看时长,首次观看直播时间
100001,小明,1小时15分30秒,2024-01-15 20:30:00
100001,小明,50分20秒,2023-12-15 21:00:00
100001,小明,45分10秒,2023-10-01 19:00:00
```

**处理结果**:
- 小明在2024-01-15: ✅ 获得1分
- 小明在2023-12-15: ✅ 获得1分
- 小明在2023-10-01: ❌ 数据过期，不获得积分
- 小明总积分: 2分，有效天数: 2天

## 系统日志

导入历史数据时，系统会显示详细的处理日志：

```
✅ 使用列 '首次观看直播时间' 作为日期
📅 过滤掉 2 条超过 90 天的历史数据
   保留 8 条有效数据（2023-10-26 之后）
✅ 添加了 6 条新的积分记录
📊 处理完成: 3个用户，总积分8分
```

## 注意事项

### 1. 数据质量

- **时间格式**: 确保时间列格式正确
- **时长格式**: 确保时长列可以被正确解析
- **用户标识**: 确保用户ID的一致性

### 2. 重复导入

- **自动去重**: 系统会自动检查重复记录
- **安全导入**: 多次导入同一文件不会产生重复积分
- **增量更新**: 只添加新的有效记录

### 3. 有效期管理

- **90天规则**: 只有90天内的数据才能获得积分
- **自动清理**: 系统会自动清理过期的历史记录
- **实时更新**: 每次导入都会重新计算有效期

## 最佳实践

### 1. 数据准备

```
建议的列名:
- 用户标识: 用户id, 用户ID, UserID
- 用户名称: 用户名称, 用户昵称, 昵称
- 观看时长: 直播观看时长, 观看时长, 时长
- 开始时间: 首次观看直播时间, 开始时间
- 结束时间: 最近观看直播时间, 结束时间
```

### 2. 导入策略

```
按时间顺序导入:
1. 最早的历史数据
2. 中期的历史数据  
3. 最新的当前数据

这样可以确保积分记录的时间顺序正确
```

### 3. 数据验证

```
导入前检查:
- 时间列是否存在且格式正确
- 时长列是否可以被解析
- 用户ID是否一致
- 数据是否在有效期内
```

## 故障排除

### 常见问题

1. **"未找到时间列"警告**
   - 检查文件是否包含时间相关的列
   - 确认列名是否正确

2. **"所有数据都超过了90天有效期"错误**
   - 检查数据的时间是否过于久远
   - 确认时间格式是否正确

3. **积分计算不正确**
   - 检查时长是否大于等于40分钟
   - 确认是否有重复的日期记录

### 解决方案

1. **检查数据格式**
   ```python
   # 检查时间列
   df['首次观看直播时间'].head()
   
   # 检查时长列
   df['直播观看时长'].head()
   ```

2. **验证日期范围**
   ```python
   # 检查日期范围
   pd.to_datetime(df['首次观看直播时间']).min()
   pd.to_datetime(df['首次观看直播时间']).max()
   ```

3. **查看系统日志**
   - 关注控制台输出的警告和错误信息
   - 根据提示调整数据格式

## 更新日志

### v2.0 - 历史数据支持
- ✅ 添加智能日期提取功能
- ✅ 实现历史数据过滤机制
- ✅ 改进积分累计算法
- ✅ 增强重复检查逻辑
- ✅ 优化用户体验和错误提示

### v1.0 - 基础功能
- ✅ 基本的数据导入功能
- ✅ 积分计算和统计
- ✅ 用户查询功能
